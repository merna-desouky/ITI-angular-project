import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
const permissionTypes = {
    notify: 1,
    friends: 2,
    photos: 4,
    audio: 8,
    video: 16,
    offers: 32,
    questions: 64,
    pages: 128,
    links: 256,
    status: 1024,
    notes: 2048,
    messages: 4096,
    wall: 8192,
    ads: 32768,
    offline: 65536,
    docs: 131072,
    groups: 262144,
    notifications: 524288,
    stats: 1048576,
    email: 4194304,
    market: 134217728
};
export class VKLoginProvider extends BaseLoginProvider {
    constructor(clientId, initOptions = {
        fields: 'photo_max,contacts',
        version: '5.131',
    }) {
        super();
        this.clientId = clientId;
        this.initOptions = initOptions;
        this.VK_API_URL = '//vk.com/js/api/openapi.js';
        this.VK_API_GET_USER = 'users.get';
    }
    static { this.PROVIDER_ID = 'VK'; }
    initialize() {
        return new Promise((resolve, reject) => {
            try {
                this.loadScript(VKLoginProvider.PROVIDER_ID, this.VK_API_URL, () => {
                    VK.init({
                        apiId: this.clientId,
                    });
                    resolve();
                });
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return new Promise((resolve) => this.getLoginStatusInternal(resolve));
    }
    signIn(permissions) {
        if (permissions?.includes('offers')) {
            console.warn('The "offers" permission is outdated.');
        }
        if (permissions?.includes('questions')) {
            console.warn('The "questions" permission is outdated.');
        }
        if (permissions?.includes('messages')) {
            console.warn('The "messages" permission is unavailable for non-standalone applications.');
        }
        const scope = permissions?.reduce((accumulator, current) => {
            const index = Object.keys(permissionTypes).findIndex(pt => pt === current);
            return index > -1 ? accumulator + permissionTypes[current] : 0;
        }, 0);
        return new Promise((resolve) => this.signInInternal(resolve, scope));
    }
    signOut() {
        return new Promise((resolve) => {
            VK.Auth.logout(() => {
                resolve();
            });
        });
    }
    signInInternal(resolve, scope) {
        VK.Auth.login((loginResponse) => {
            if (loginResponse.status === 'connected') {
                this.getUser(loginResponse.session.mid, loginResponse.session.sid, resolve);
            }
        }, scope);
    }
    getUser(userId, token, resolve) {
        VK.Api.call(this.VK_API_GET_USER, {
            user_id: userId,
            fields: this.initOptions.fields,
            v: this.initOptions.version,
        }, (userResponse) => {
            resolve(this.createUser(Object.assign({}, { token }, userResponse.response[0])));
        });
    }
    getLoginStatusInternal(resolve) {
        VK.Auth.getLoginStatus((loginResponse) => {
            if (loginResponse.status === 'connected') {
                this.getUser(loginResponse.session.mid, loginResponse.session.sid, resolve);
            }
        });
    }
    createUser(response) {
        const user = new SocialUser();
        user.id = response.id;
        user.name = `${response.first_name} ${response.last_name}`;
        user.photoUrl = response.photo_max;
        user.authToken = response.token;
        return user;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmstbG9naW4tcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9saWIvc3JjL3Byb3ZpZGVycy92ay1sb2dpbi1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJckQsTUFBTSxlQUFlLEdBQUc7SUFDdEIsTUFBTSxFQUFFLENBQUM7SUFDVCxPQUFPLEVBQUUsQ0FBQztJQUNWLE1BQU0sRUFBRSxDQUFDO0lBQ1QsS0FBSyxFQUFFLENBQUM7SUFDUixLQUFLLEVBQUUsRUFBRTtJQUNULE1BQU0sRUFBRSxFQUFFO0lBQ1YsU0FBUyxFQUFFLEVBQUU7SUFDYixLQUFLLEVBQUUsR0FBRztJQUNWLEtBQUssRUFBRSxHQUFHO0lBQ1YsTUFBTSxFQUFFLElBQUk7SUFDWixLQUFLLEVBQUUsSUFBSTtJQUNYLFFBQVEsRUFBRSxJQUFJO0lBQ2QsSUFBSSxFQUFFLElBQUk7SUFDVixHQUFHLEVBQUUsS0FBSztJQUNWLE9BQU8sRUFBRSxLQUFLO0lBQ2QsSUFBSSxFQUFFLE1BQU07SUFDWixNQUFNLEVBQUUsTUFBTTtJQUNkLGFBQWEsRUFBRSxNQUFNO0lBQ3JCLEtBQUssRUFBRSxPQUFPO0lBQ2QsS0FBSyxFQUFFLE9BQU87SUFDZCxNQUFNLEVBQUUsU0FBUztDQUNsQixDQUFDO0FBRUYsTUFBTSxPQUFPLGVBQWdCLFNBQVEsaUJBQWlCO0lBQ3BELFlBQ1UsUUFBZ0IsRUFDaEIsY0FBYztRQUNwQixNQUFNLEVBQUUsb0JBQW9CO1FBQzVCLE9BQU8sRUFBRSxPQUFPO0tBQ2pCO1FBRUQsS0FBSyxFQUFFLENBQUM7UUFOQSxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ2hCLGdCQUFXLEdBQVgsV0FBVyxDQUdsQjtRQU9jLGVBQVUsR0FBRyw0QkFB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QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VMb2dpblByb3ZpZGVyIH0gZnJvbSAnLi4vZW50aXRpZXMvYmFzZS1sb2dpbi1wcm92aWRlcic7XHJcbmltcG9ydCB7IFNvY2lhbFVzZXIgfSBmcm9tICcuLi9lbnRpdGllcy9zb2NpYWwtdXNlcic7XHJcblxyXG5kZWNsYXJlIGxldCBWSzogYW55O1xyXG5cclxuY29uc3QgcGVybWlzc2lvblR5cGVzID0ge1xyXG4gIG5vdGlmeTogMSxcclxuICBmcmllbmRzOiAyLFxyXG4gIHBob3RvczogNCxcclxuICBhdWRpbzogOCxcclxuICB2aWRlbzogMTYsXHJcbiAgb2ZmZXJzOiAzMixcclxuICBxdWVzdGlvbnM6IDY0LFxyXG4gIHBhZ2VzOiAxMjgsXHJcbiAgbGlua3M6IDI1NixcclxuICBzdGF0dXM6IDEwMjQsXHJcbiAgbm90ZXM6IDIwNDgsXHJcbiAgbWVzc2FnZXM6IDQwOTYsXHJcbiAgd2FsbDogODE5MixcclxuICBhZHM6IDMyNzY4LFxyXG4gIG9mZmxpbmU6IDY1NTM2LCBcclxuICBkb2NzOiAxMzEwNzIsXHJcbiAgZ3JvdXBzOiAyNjIxNDQsXHJcbiAgbm90aWZpY2F0aW9uczogNTI0Mjg4LFxyXG4gIHN0YXRzOiAxMDQ4NTc2LFxyXG4gIGVtYWlsOiA0MTk0MzA0LFxyXG4gIG1hcmtldDogMTM0MjE3NzI4XHJcbn07XHJcblxyXG5leHBvcnQgY2xhc3MgVktMb2dpblByb3ZpZGVyIGV4dGVuZHMgQmFzZUxvZ2luUHJvdmlkZXIge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBjbGllbnRJZDogc3RyaW5nLFxyXG4gICAgcHJpdmF0ZSBpbml0T3B0aW9ucyA9IHtcclxuICAgICAgZmllbGRzOiAncGhvdG9fbWF4LGNvbnRhY3RzJyxcclxuICAgICAgdmVyc2lvbjogJzUuMTMxJyxcclxuICAgIH1cclxuICApIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFBST1ZJREVSX0lEOiBzdHJpbmcgPSAnVksnO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IFZLX0FQSV9VUkwgPSAnLy92ay5jb20vanMvYXBpL29wZW5hcGkuanMnO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgVktfQVBJX0dFVF9VU0VSID0gJ3VzZXJzLmdldCc7XHJcblxyXG4gIGluaXRpYWxpemUoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIHRoaXMubG9hZFNjcmlwdChcclxuICAgICAgICAgIFZLTG9naW5Qcm92aWRlci5QUk9WSURFUl9JRCxcclxuICAgICAgICAgIHRoaXMuVktfQVBJX1VSTCxcclxuICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgVksuaW5pdCh7XHJcbiAgICAgICAgICAgICAgYXBpSWQ6IHRoaXMuY2xpZW50SWQsXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldExvZ2luU3RhdHVzKCk6IFByb21pc2U8U29jaWFsVXNlcj4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFNvY2lhbFVzZXI+KChyZXNvbHZlOiAodmFsdWU6IFNvY2lhbFVzZXIpID0+IHZvaWQpID0+XHJcbiAgICAgIHRoaXMuZ2V0TG9naW5TdGF0dXNJbnRlcm5hbChyZXNvbHZlKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHNpZ25JbihwZXJtaXNzaW9uczogc3RyaW5nW10pOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIGlmIChwZXJtaXNzaW9ucz8uaW5jbHVkZXMoJ29mZmVycycpKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybignVGhlIFwib2ZmZXJzXCIgcGVybWlzc2lvbiBpcyBvdXRkYXRlZC4nKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocGVybWlzc2lvbnM/LmluY2x1ZGVzKCdxdWVzdGlvbnMnKSkge1xyXG4gICAgICBjb25zb2xlLndhcm4oJ1RoZSBcInF1ZXN0aW9uc1wiIHBlcm1pc3Npb24gaXMgb3V0ZGF0ZWQuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHBlcm1pc3Npb25zPy5pbmNsdWRlcygnbWVzc2FnZXMnKSkge1xyXG4gICAgICBjb25zb2xlLndhcm4oJ1RoZSBcIm1lc3NhZ2VzXCIgcGVybWlzc2lvbiBpcyB1bmF2YWlsYWJsZSBmb3Igbm9uLXN0YW5kYWxvbmUgYXBwbGljYXRpb25zLicpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHNjb3BlID0gcGVybWlzc2lvbnM/LnJlZHVjZSgoYWNjdW11bGF0b3IsIGN1cnJlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBpbmRleCA9IE9iamVjdC5rZXlzKHBlcm1pc3Npb25UeXBlcykuZmluZEluZGV4KHB0ID0+IHB0ID09PSBjdXJyZW50KTtcclxuICAgICAgICByZXR1cm4gaW5kZXggPiAtMSA/IGFjY3VtdWxhdG9yICsgcGVybWlzc2lvblR5cGVzW2N1cnJlbnRdIDogMDtcclxuICAgICAgfSwgMCk7XHJcblxyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFNvY2lhbFVzZXI+KChyZXNvbHZlOiAodmFsdWU6IFNvY2lhbFVzZXIpID0+IHZvaWQpID0+XHJcbiAgICAgIHRoaXMuc2lnbkluSW50ZXJuYWwocmVzb2x2ZSwgc2NvcGUpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc2lnbk91dCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZTogKHZhbHVlOiB2b2lkIHwgUHJvbWlzZUxpa2U8dm9pZD4pID0+IHZvaWQpID0+IHtcclxuICAgICAgVksuQXV0aC5sb2dvdXQoKCkgPT4ge1xyXG4gICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2lnbkluSW50ZXJuYWwoXHJcbiAgICByZXNvbHZlOiAodmFsdWU6IFNvY2lhbFVzZXIpID0+IHZvaWQsIFxyXG4gICAgc2NvcGU6YW55XHJcbiAgKSB7XHJcbiAgICBWSy5BdXRoLmxvZ2luKChsb2dpblJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGxvZ2luUmVzcG9uc2Uuc3RhdHVzID09PSAnY29ubmVjdGVkJykge1xyXG4gICAgICAgIHRoaXMuZ2V0VXNlcihcclxuICAgICAgICAgIGxvZ2luUmVzcG9uc2Uuc2Vzc2lvbi5taWQsXHJcbiAgICAgICAgICBsb2dpblJlc3BvbnNlLnNlc3Npb24uc2lkLFxyXG4gICAgICAgICAgcmVzb2x2ZVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0sIHNjb3BlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0VXNlcihcclxuICAgIHVzZXJJZDogbnVtYmVyLCBcclxuICAgIHRva2VuOiBzdHJpbmcsIFxyXG4gICAgcmVzb2x2ZTogKHZhbHVlOiBTb2NpYWxVc2VyKSA9PiB2b2lkXHJcbiAgKSB7XHJcbiAgICBWSy5BcGkuY2FsbChcclxuICAgICAgdGhpcy5WS19BUElfR0VUX1VTRVIsXHJcbiAgICAgIHtcclxuICAgICAgICB1c2VyX2lkOiB1c2VySWQsXHJcbiAgICAgICAgZmllbGRzOiB0aGlzLmluaXRPcHRpb25zLmZpZWxkcyxcclxuICAgICAgICB2OiB0aGlzLmluaXRPcHRpb25zLnZlcnNpb24sXHJcbiAgICAgIH0sXHJcbiAgICAgICh1c2VyUmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgIHJlc29sdmUoXHJcbiAgICAgICAgICB0aGlzLmNyZWF0ZVVzZXIoXHJcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIHsgdG9rZW4gfSwgdXNlclJlc3BvbnNlLnJlc3BvbnNlWzBdKVxyXG4gICAgICAgICAgKVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldExvZ2luU3RhdHVzSW50ZXJuYWwocmVzb2x2ZTogKHZhbHVlOiBTb2NpYWxVc2VyKSA9PiB2b2lkKSB7XHJcbiAgICBWSy5BdXRoLmdldExvZ2luU3RhdHVzKChsb2dpblJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGxvZ2luUmVzcG9uc2Uuc3RhdHVzID09PSAnY29ubmVjdGVkJykge1xyXG4gICAgICAgIHRoaXMuZ2V0VXNlcihcclxuICAgICAgICAgIGxvZ2luUmVzcG9uc2Uuc2Vzc2lvbi5taWQsXHJcbiAgICAgICAgICBsb2dpblJlc3BvbnNlLnNlc3Npb24uc2lkLFxyXG4gICAgICAgICAgcmVzb2x2ZVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjcmVhdGVVc2VyKHJlc3BvbnNlOiBhbnkpOiBTb2NpYWxVc2VyIHtcclxuICAgIGNvbnN0IHVzZXI6IFNvY2lhbFVzZXIgPSBuZXcgU29jaWFsVXNlcigpO1xyXG4gICAgdXNlci5pZCA9IHJlc3BvbnNlLmlkO1xyXG4gICAgdXNlci5uYW1lID0gYCR7cmVzcG9uc2UuZmlyc3RfbmFtZX0gJHtyZXNwb25zZS5sYXN0X25hbWV9YDtcclxuICAgIHVzZXIucGhvdG9VcmwgPSByZXNwb25zZS5waG90b19tYXg7XHJcbiAgICB1c2VyLmF1dGhUb2tlbiA9IHJlc3BvbnNlLnRva2VuO1xyXG4gICAgcmV0dXJuIHVzZXI7XHJcbiAgfVxyXG59XHJcbiJdfQ==