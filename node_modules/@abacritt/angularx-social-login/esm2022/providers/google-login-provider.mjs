import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
import { EventEmitter } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { filter, skip, take } from 'rxjs/operators';
const defaultInitOptions = {
    oneTapEnabled: true,
};
export class GoogleLoginProvider extends BaseLoginProvider {
    static { this.PROVIDER_ID = 'GOOGLE'; }
    constructor(clientId, initOptions) {
        super();
        this.clientId = clientId;
        this.initOptions = initOptions;
        this.changeUser = new EventEmitter();
        this._socialUser = new BehaviorSubject(null);
        this._accessToken = new BehaviorSubject(null);
        this._receivedAccessToken = new EventEmitter();
        this.initOptions = { ...defaultInitOptions, ...this.initOptions };
        // emit changeUser events but skip initial value from behaviorSubject
        this._socialUser.pipe(skip(1)).subscribe(this.changeUser);
        // emit receivedAccessToken but skip initial value from behaviorSubject
        this._accessToken.pipe(skip(1)).subscribe(this._receivedAccessToken);
    }
    initialize(autoLogin) {
        return new Promise((resolve, reject) => {
            try {
                this.loadScript(GoogleLoginProvider.PROVIDER_ID, 'https://accounts.google.com/gsi/client', () => {
                    google.accounts.id.initialize({
                        client_id: this.clientId,
                        auto_select: autoLogin,
                        callback: ({ credential }) => {
                            const socialUser = this.createSocialUser(credential);
                            this._socialUser.next(socialUser);
                        },
                        prompt_parent_id: this.initOptions?.prompt_parent_id,
                        itp_support: this.initOptions.oneTapEnabled
                    });
                    if (this.initOptions.oneTapEnabled) {
                        this._socialUser
                            .pipe(filter((user) => user === null))
                            .subscribe(() => google.accounts.id.prompt(console.debug));
                    }
                    if (this.initOptions.scopes) {
                        const scope = this.initOptions.scopes instanceof Array
                            ? this.initOptions.scopes.filter((s) => s).join(' ')
                            : this.initOptions.scopes;
                        this._tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: this.clientId,
                            scope,
                            prompt: this.initOptions.prompt,
                            callback: (tokenResponse) => {
                                if (tokenResponse.error) {
                                    this._accessToken.error({
                                        code: tokenResponse.error,
                                        description: tokenResponse.error_description,
                                        uri: tokenResponse.error_uri,
                                    });
                                }
                                else {
                                    this._accessToken.next(tokenResponse.access_token);
                                }
                            },
                        });
                    }
                    resolve();
                });
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return new Promise((resolve, reject) => {
            if (this._socialUser.value) {
                resolve(this._socialUser.value);
            }
            else {
                reject(`No user is currently logged in with ${GoogleLoginProvider.PROVIDER_ID}`);
            }
        });
    }
    refreshToken() {
        return new Promise((resolve, reject) => {
            google.accounts.id.revoke(this._socialUser.value.id, (response) => {
                if (response.error)
                    reject(response.error);
                else
                    resolve(this._socialUser.value);
            });
        });
    }
    getAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                if (this._socialUser.value) {
                    reject('No token client was instantiated, you should specify some scopes.');
                }
                else {
                    reject('You should be logged-in first.');
                }
            }
            else {
                this._tokenClient.requestAccessToken({
                    hint: this._socialUser.value?.email,
                });
                this._receivedAccessToken.pipe(take(1)).subscribe(resolve);
            }
        });
    }
    revokeAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                reject('No token client was instantiated, you should specify some scopes.');
            }
            else if (!this._accessToken.value) {
                reject('No access token to revoke');
            }
            else {
                google.accounts.oauth2.revoke(this._accessToken.value, () => {
                    this._accessToken.next(null);
                    resolve();
                });
            }
        });
    }
    signIn() {
        return Promise.reject('You should not call this method directly for Google, use "<asl-google-signin-button>" wrapper ' +
            'or generate the button yourself with "google.accounts.id.renderButton()" ' +
            '(https://developers.google.com/identity/gsi/web/guides/display-button#javascript)');
    }
    async signOut() {
        google.accounts.id.disableAutoSelect();
        this._socialUser.next(null);
    }
    createSocialUser(idToken) {
        const user = new SocialUser();
        user.idToken = idToken;
        const payload = this.decodeJwt(idToken);
        user.id = payload.sub;
        user.name = payload.name;
        user.email = payload.email;
        user.photoUrl = payload.picture;
        user.firstName = payload['given_name'];
        user.lastName = payload['family_name'];
        return user;
    }
    decodeJwt(idToken) {
        const base64Url = idToken.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(window.atob(base64)
            .split("")
            .map(function (c) {
            return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
        })
            .join(""));
        return JSON.parse(jsonPayload);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbGliL3NyYy9wcm92aWRlcnMvZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUErQnBELE1BQU0sa0JBQWtCLEdBQXNCO0lBQzVDLGFBQWEsRUFBRSxJQUFJO0NBQ3BCLENBQUM7QUFFRixNQUFNLE9BQU8sbUJBQW9CLFNBQVEsaUJBQWlCO2FBQ2pDLGdCQUFXLEdBQVcsUUFBUSxBQUFuQixDQUFvQjtJQVN0RCxZQUNVLFFBQWdCLEVBQ1AsV0FBK0I7UUFFaEQsS0FBSyxFQUFFLENBQUM7UUFIQSxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ1AsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBVGxDLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBcUIsQ0FBQztRQUVsRCxnQkFBVyxHQUFHLElBQUksZUFBZSxDQUFvQixJQUFJLENBQUMsQ0FBQztRQUMzRCxpQkFBWSxHQUFHLElBQUksZUFBZSxDQUFnQixJQUFJLENBQUMsQ0FBQztRQUN4RCx5QkFBb0IsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO1FBU2pFLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxHQUFHLGtCQUFrQixFQUFFLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRWxFLHFFQUFxRTtRQUNyRSxJQUFJLENBQUMs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Q0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUNaLENBQUM7UUFDRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDakMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VMb2dpblByb3ZpZGVyIH0gZnJvbSAnLi4vZW50aXRpZXMvYmFzZS1sb2dpbi1wcm92aWRlcic7XHJcbmltcG9ydCB7IFNvY2lhbFVzZXIgfSBmcm9tICcuLi9lbnRpdGllcy9zb2NpYWwtdXNlcic7XHJcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZmlsdGVyLCBza2lwLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBHb29nbGVJbml0T3B0aW9ucyB7XHJcbiAgLyoqXHJcbiAgICogZW5hYmxlcyB0aGUgT25lIFRhcCBtZWNoYW5pc20sIGFuZCBtYWtlcyBhdXRvLWxvZ2luIHBvc3NpYmxlXHJcbiAgICovXHJcbiAgb25lVGFwRW5hYmxlZD86IGJvb2xlYW47XHJcbiAgLyoqXHJcbiAgICogbGlzdCBvZiBwZXJtaXNzaW9uIHNjb3BlcyB0byBncmFudCBpbiBjYXNlIHdlIHJlcXVlc3QgYW4gYWNjZXNzIHRva2VuXHJcbiAgICovXHJcbiAgc2NvcGVzPzogc3RyaW5nIHwgc3RyaW5nW107XHJcbiAvKipcclxuICAgKiBUaGlzIGF0dHJpYnV0ZSBzZXRzIHRoZSBET00gSUQgb2YgdGhlIGNvbnRhaW5lciBlbGVtZW50LiBJZiBpdCdzIG5vdCBzZXQsIHRoZSBPbmUgVGFwIHByb21wdCBpcyBkaXNwbGF5ZWQgaW4gdGhlIHRvcC1yaWdodCBjb3JuZXIgb2YgdGhlIHdpbmRvdy5cclxuICAgKi9cclxuICBwcm9tcHRfcGFyZW50X2lkPzogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiBPcHRpb25hbCwgZGVmYXVsdHMgdG8gJ3NlbGVjdF9hY2NvdW50Jy5cclxuICAgKiBBIHNwYWNlLWRlbGltaXRlZCwgY2FzZS1zZW5zaXRpdmUgbGlzdCBvZiBwcm9tcHRzIHRvIHByZXNlbnQgdGhlXHJcbiAgICogdXNlci5cclxuICAgKiBQb3NzaWJsZSB2YWx1ZXMgYXJlOlxyXG4gICAqIGVtcHR5IHN0cmluZyBUaGUgdXNlciB3aWxsIGJlIHByb21wdGVkIG9ubHkgdGhlIGZpcnN0IHRpbWUgeW91clxyXG4gICAqICAgICBhcHAgcmVxdWVzdHMgYWNjZXNzLiBDYW5ub3QgYmUgc3BlY2lmaWVkIHdpdGggb3RoZXIgdmFsdWVzLlxyXG4gICAqICdub25lJyBEbyBub3QgZGlzcGxheSBhbnkgYXV0aGVudGljYXRpb24gb3IgY29uc2VudCBzY3JlZW5zLiBNdXN0XHJcbiAgICogICAgIG5vdCBiZSBzcGVjaWZpZWQgd2l0aCBvdGhlciB2YWx1ZXMuXHJcbiAgICogJ2NvbnNlbnQnIFByb21wdCB0aGUgdXNlciBmb3IgY29uc2VudC5cclxuICAgKiAnc2VsZWN0X2FjY291bnQnIFByb21wdCB0aGUgdXNlciB0byBzZWxlY3QgYW4gYWNjb3VudC5cclxuICAgKi9cclxuICBwcm9tcHQ/IDogJycgfCAnbm9uZScgfCAnY29uc2VudCcgfCAnc2VsZWN0X2FjY291bnQnO1xyXG59XHJcblxyXG5jb25zdCBkZWZhdWx0SW5pdE9wdGlvbnM6IEdvb2dsZUluaXRPcHRpb25zID0ge1xyXG4gIG9uZVRhcEVuYWJsZWQ6IHRydWUsXHJcbn07XHJcblxyXG5leHBvcnQgY2xhc3MgR29vZ2xlTG9naW5Qcm92aWRlciBleHRlbmRzIEJhc2VMb2dpblByb3ZpZGVyIHtcclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFBST1ZJREVSX0lEOiBzdHJpbmcgPSAnR09PR0xFJztcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IGNoYW5nZVVzZXIgPSBuZXcgRXZlbnRFbWl0dGVyPFNvY2lhbFVzZXIgfCBudWxsPigpO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IF9zb2NpYWxVc2VyID0gbmV3IEJlaGF2aW9yU3ViamVjdDxTb2NpYWxVc2VyIHwgbnVsbD4obnVsbCk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBfYWNjZXNzVG9rZW4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZyB8IG51bGw+KG51bGwpO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3JlY2VpdmVkQWNjZXNzVG9rZW4gPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuICBwcml2YXRlIF90b2tlbkNsaWVudDogZ29vZ2xlLmFjY291bnRzLm9hdXRoMi5Ub2tlbkNsaWVudCB8IHVuZGVmaW5lZDtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGNsaWVudElkOiBzdHJpbmcsXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGluaXRPcHRpb25zPzogR29vZ2xlSW5pdE9wdGlvbnNcclxuICApIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgdGhpcy5pbml0T3B0aW9ucyA9IHsgLi4uZGVmYXVsdEluaXRPcHRpb25zLCAuLi50aGlzLmluaXRPcHRpb25zIH07XHJcblxyXG4gICAgLy8gZW1pdCBjaGFuZ2VVc2VyIGV2ZW50cyBidXQgc2tpcCBpbml0aWFsIHZhbHVlIGZyb20gYmVoYXZpb3JTdWJqZWN0XHJcbiAgICB0aGlzLl9zb2NpYWxVc2VyLnBpcGUoc2tpcCgxKSkuc3Vic2NyaWJlKHRoaXMuY2hhbmdlVXNlcik7XHJcblxyXG4gICAgLy8gZW1pdCByZWNlaXZlZEFjY2Vzc1Rva2VuIGJ1dCBza2lwIGluaXRpYWwgdmFsdWUgZnJvbSBiZWhhdmlvclN1YmplY3RcclxuICAgIHRoaXMuX2FjY2Vzc1Rva2VuLnBpcGUoc2tpcCgxKSkuc3Vic2NyaWJlKHRoaXMuX3JlY2VpdmVkQWNjZXNzVG9rZW4pO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZShhdXRvTG9naW4/OiBib29sZWFuKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIHRoaXMubG9hZFNjcmlwdChcclxuICAgICAgICAgIEdvb2dsZUxvZ2luUHJvdmlkZXIuUFJPVklERVJfSUQsXHJcbiAgICAgICAgICAnaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL2dzaS9jbGllbnQnLFxyXG4gICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICBnb29nbGUuYWNjb3VudHMuaWQuaW5pdGlhbGl6ZSh7XHJcbiAgICAgICAgICAgICAgY2xpZW50X2lkOiB0aGlzLmNsaWVudElkLFxyXG4gICAgICAgICAgICAgIGF1dG9fc2VsZWN0OiBhdXRvTG9naW4sXHJcbiAgICAgICAgICAgICAgY2FsbGJhY2s6ICh7IGNyZWRlbnRpYWwgfSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc29jaWFsVXNlciA9IHRoaXMuY3JlYXRlU29jaWFsVXNlcihjcmVkZW50aWFsKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3NvY2lhbFVzZXIubmV4dChzb2NpYWxVc2VyKTtcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIHByb21wdF9wYXJlbnRfaWQ6IHRoaXMuaW5pdE9wdGlvbnM/LnByb21wdF9wYXJlbnRfaWQsXHJcbiAgICAgICAgICAgICAgaXRwX3N1cHBvcnQ6IHRoaXMuaW5pdE9wdGlvbnMub25lVGFwRW5hYmxlZFxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmluaXRPcHRpb25zLm9uZVRhcEVuYWJsZWQpIHtcclxuICAgICAgICAgICAgICB0aGlzLl9zb2NpYWxVc2VyXHJcbiAgICAgICAgICAgICAgICAucGlwZShmaWx0ZXIoKHVzZXIpID0+IHVzZXIgPT09IG51bGwpKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiBnb29nbGUuYWNjb3VudHMuaWQucHJvbXB0KGNvbnNvbGUuZGVidWcpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzKSB7XHJcbiAgICAgICAgICAgICAgY29uc3Qgc2NvcGUgPVxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucy5zY29wZXMgaW5zdGFuY2VvZiBBcnJheVxyXG4gICAgICAgICAgICAgICAgICA/IHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzLmZpbHRlcigocykgPT4gcykuam9pbignICcpXHJcbiAgICAgICAgICAgICAgICAgIDogdGhpcy5pbml0T3B0aW9ucy5zY29wZXM7XHJcblxyXG4gICAgICAgICAgICAgIHRoaXMuX3Rva2VuQ2xpZW50ID0gZ29vZ2xlLmFjY291bnRzLm9hdXRoMi5pbml0VG9rZW5DbGllbnQoe1xyXG4gICAgICAgICAgICAgICAgY2xpZW50X2lkOiB0aGlzLmNsaWVudElkLFxyXG4gICAgICAgICAgICAgICAgc2NvcGUsXHJcbiAgICAgICAgICAgICAgICBwcm9tcHQgOiB0aGlzLmluaXRPcHRpb25zLnByb21wdCxcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrOiAodG9rZW5SZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBpZiAodG9rZW5SZXNwb25zZS5lcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY2Vzc1Rva2VuLmVycm9yKHtcclxuICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IHRva2VuUmVzcG9uc2UuZXJyb3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdG9rZW5SZXNwb25zZS5lcnJvcl9kZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgICAgICAgICAgIHVyaTogdG9rZW5SZXNwb25zZS5lcnJvcl91cmksXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjZXNzVG9rZW4ubmV4dCh0b2tlblJlc3BvbnNlLmFjY2Vzc190b2tlbik7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRMb2dpblN0YXR1cygpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLl9zb2NpYWxVc2VyLnZhbHVlKSB7XHJcbiAgICAgICAgcmVzb2x2ZSh0aGlzLl9zb2NpYWxVc2VyLnZhbHVlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZWplY3QoXHJcbiAgICAgICAgICBgTm8gdXNlciBpcyBjdXJyZW50bHkgbG9nZ2VkIGluIHdpdGggJHtHb29nbGVMb2dpblByb3ZpZGVyLlBST1ZJREVSX0lEfWBcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJlZnJlc2hUb2tlbigpOiBQcm9taXNlPFNvY2lhbFVzZXIgfCBudWxsPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBnb29nbGUuYWNjb3VudHMuaWQucmV2b2tlKHRoaXMuX3NvY2lhbFVzZXIudmFsdWUuaWQsIChyZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGlmIChyZXNwb25zZS5lcnJvcikgcmVqZWN0KHJlc3BvbnNlLmVycm9yKTtcclxuICAgICAgICBlbHNlIHJlc29sdmUodGhpcy5fc29jaWFsVXNlci52YWx1ZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRBY2Nlc3NUb2tlbigpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLl90b2tlbkNsaWVudCkge1xyXG4gICAgICAgIGlmICh0aGlzLl9zb2NpYWxVc2VyLnZhbHVlKSB7XHJcbiAgICAgICAgICByZWplY3QoXHJcbiAgICAgICAgICAgICdObyB0b2tlbiBjbGllbnQgd2FzIGluc3RhbnRpYXRlZCwgeW91IHNob3VsZCBzcGVjaWZ5IHNvbWUgc2NvcGVzLidcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlamVjdCgnWW91IHNob3VsZCBiZSBsb2dnZWQtaW4gZmlyc3QuJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuX3Rva2VuQ2xpZW50LnJlcXVlc3RBY2Nlc3NUb2tlbih7XHJcbiAgICAgICAgICBoaW50OiB0aGlzLl9zb2NpYWxVc2VyLnZhbHVlPy5lbWFpbCxcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLl9yZWNlaXZlZEFjY2Vzc1Rva2VuLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKHJlc29sdmUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJldm9rZUFjY2Vzc1Rva2VuKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLl90b2tlbkNsaWVudCkge1xyXG4gICAgICAgIHJlamVjdChcclxuICAgICAgICAgICdObyB0b2tlbiBjbGllbnQgd2FzIGluc3RhbnRpYXRlZCwgeW91IHNob3VsZCBzcGVjaWZ5IHNvbWUgc2NvcGVzLidcclxuICAgICAgICApO1xyXG4gICAgICB9IGVsc2UgaWYgKCF0aGlzLl9hY2Nlc3NUb2tlbi52YWx1ZSkge1xyXG4gICAgICAgIHJlamVjdCgnTm8gYWNjZXNzIHRva2VuIHRvIHJldm9rZScpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGdvb2dsZS5hY2NvdW50cy5vYXV0aDIucmV2b2tlKHRoaXMuX2FjY2Vzc1Rva2VuLnZhbHVlLCAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLl9hY2Nlc3NUb2tlbi5uZXh0KG51bGwpO1xyXG4gICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHNpZ25JbigpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChcclxuICAgICAgJ1lvdSBzaG91bGQgbm90IGNhbGwgdGhpcyBtZXRob2QgZGlyZWN0bHkgZm9yIEdvb2dsZSwgdXNlIFwiPGFzbC1nb29nbGUtc2lnbmluLWJ1dHRvbj5cIiB3cmFwcGVyICcgK1xyXG4gICAgICAgICdvciBnZW5lcmF0ZSB0aGUgYnV0dG9uIHlvdXJzZWxmIHdpdGggXCJnb29nbGUuYWNjb3VudHMuaWQucmVuZGVyQnV0dG9uKClcIiAnICtcclxuICAgICAgICAnKGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2lkZW50aXR5L2dzaS93ZWIvZ3VpZGVzL2Rpc3BsYXktYnV0dG9uI2phdmFzY3JpcHQpJ1xyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNpZ25PdXQoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBnb29nbGUuYWNjb3VudHMuaWQuZGlzYWJsZUF1dG9TZWxlY3QoKTtcclxuICAgIHRoaXMuX3NvY2lhbFVzZXIubmV4dChudWxsKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlU29jaWFsVXNlcihpZFRva2VuOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHVzZXIgPSBuZXcgU29jaWFsVXNlcigpO1xyXG4gICAgdXNlci5pZFRva2VuID0gaWRUb2tlbjtcclxuICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmRlY29kZUp3dChpZFRva2VuKTtcclxuICAgIHVzZXIuaWQgPSBwYXlsb2FkLnN1YjtcclxuICAgIHVzZXIubmFtZSA9IHBheWxvYWQubmFtZTtcclxuICAgIHVzZXIuZW1haWwgPSBwYXlsb2FkLmVtYWlsO1xyXG4gICAgdXNlci5waG90b1VybCA9IHBheWxvYWQucGljdHVyZTtcclxuICAgIHVzZXIuZmlyc3ROYW1lID0gcGF5bG9hZFsnZ2l2ZW5fbmFtZSddO1xyXG4gICAgdXNlci5sYXN0TmFtZSA9IHBheWxvYWRbJ2ZhbWlseV9uYW1lJ107XHJcbiAgICByZXR1cm4gdXNlcjtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZGVjb2RlSnd0KGlkVG9rZW46IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4ge1xyXG4gICAgY29uc3QgYmFzZTY0VXJsID0gaWRUb2tlbi5zcGxpdChcIi5cIilbMV07XHJcbiAgICBjb25zdCBiYXNlNjQgPSBiYXNlNjRVcmwucmVwbGFjZSgvLS9nLCBcIitcIikucmVwbGFjZSgvXy9nLCBcIi9cIik7XHJcbiAgICBjb25zdCBqc29uUGF5bG9hZCA9IGRlY29kZVVSSUNvbXBvbmVudChcclxuICAgICAgd2luZG93LmF0b2IoYmFzZTY0KVxyXG4gICAgICAgIC5zcGxpdChcIlwiKVxyXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKGMpIHtcclxuICAgICAgICAgIHJldHVybiBcIiVcIiArIChcIjAwXCIgKyBjLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpKS5zbGljZSgtMik7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuam9pbihcIlwiKVxyXG4gICAgKTtcclxuICAgIHJldHVybiBKU09OLnBhcnNlKGpzb25QYXlsb2FkKTtcclxuICB9XHJcbn1cclxuIl19